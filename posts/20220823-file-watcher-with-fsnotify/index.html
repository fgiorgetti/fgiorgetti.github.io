<!DOCTYPE html>
<html lang="en-us">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script>
  <link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> File Watcher With Fsnotify | Fernando Giorgetti - about me</title>
  <link rel = 'canonical' href = 'https://fgiorgetti.github.io/posts/20220823-file-watcher-with-fsnotify/'>
  <meta name="description" content="Software Engineer and Open source passionate user.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="File Watcher With Fsnotify" />
<meta property="og:description" content="Sometimes we need to watch for modifications in specific locations in the filesystem, reacting to them differently.
As an example, an alert could be triggered if a specific file is modified or a backup procedure could start as new files are created into specific directories.
There are several tools and libraries to help doing that, but since I am evaluating libraries in Go, I have decided to play with fsnotify and write a bit about it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://fgiorgetti.github.io/posts/20220823-file-watcher-with-fsnotify/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-23T00:21:47-03:00" />
<meta property="article:modified_time" content="2022-08-23T00:21:47-03:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="File Watcher With Fsnotify"/>
<meta name="twitter:description" content="Sometimes we need to watch for modifications in specific locations in the filesystem, reacting to them differently.
As an example, an alert could be triggered if a specific file is modified or a backup procedure could start as new files are created into specific directories.
There are several tools and libraries to help doing that, but since I am evaluating libraries in Go, I have decided to play with fsnotify and write a bit about it."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://fgiorgetti.github.io/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css" integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://fgiorgetti.github.io/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://fgiorgetti.github.io/posts/20210203-golang-bash-completion/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&text=File%20Watcher%20With%20Fsnotify" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&title=File%20Watcher%20With%20Fsnotify" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&is_video=false&description=File%20Watcher%20With%20Fsnotify" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=File%20Watcher%20With%20Fsnotify&body=Check out this article: https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&title=File%20Watcher%20With%20Fsnotify" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&title=File%20Watcher%20With%20Fsnotify" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&name=File%20Watcher%20With%20Fsnotify&description=Sometimes%20we%20need%20to%20watch%20for%20modifications%20in%20specific%20locations%20in%20the%20filesystem%2c%20reacting%20to%20them%20differently.%0aAs%20an%20example%2c%20an%20alert%20could%20be%20triggered%20if%20a%20specific%20file%20is%20modified%20or%20a%20backup%20procedure%20could%20start%20as%20new%20files%20are%20created%20into%20specific%20directories.%0aThere%20are%20several%20tools%20and%20libraries%20to%20help%20doing%20that%2c%20but%20since%20I%20am%20evaluating%20libraries%20in%20Go%2c%20I%20have%20decided%20to%20play%20with%20fsnotify%20and%20write%20a%20bit%20about%20it." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&t=File%20Watcher%20With%20Fsnotify" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#fsnotify">fsnotify</a></li>
    <li><a href="#goal">Goal</a></li>
    <li><a href="#quick-start">Quick start</a></li>
    <li><a href="#solution">Solution</a>
      <ul>
        <li><a href="#watchergo">watcher.go</a></li>
        <li><a href="#fwgo">fw.go</a></li>
        <li><a href="#running">Running</a></li>
      </ul>
    </li>
    <li><a href="#system-information">System information</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        File Watcher With Fsnotify
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2022-08-23 00:21:47 -0300 -03" itemprop="datePublished">2022-08-23</time>
          
        </div>
        
        
        
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <p>Sometimes we need to watch for modifications in specific locations in
the filesystem, reacting to them differently.</p>
<p>As an example, an alert could be triggered if a specific file is modified
or a backup procedure could start as new files are created into specific
directories.</p>
<p>There are several tools and libraries to help doing that, but since I am
evaluating libraries in Go, I have decided to play with <a href="https://github.com/fsnotify/fsnotify">fsnotify</a> and write a bit about it.</p>
<h2 id="fsnotify">fsnotify</h2>
<p>It is a library written in Go that uses <a href="https://pkg.go.dev/golang.org/x/sys">https://pkg.go.dev/golang.org/x/sys</a> instead of
<a href="https://pkg.go.dev/syscall">https://pkg.go.dev/syscall</a> (from the standard library).</p>
<p>Fsnotify is supported on Linux, macOS, Windows and other operating systems.</p>
<p>With fsnotify you can create a <code>Watcher</code> instance that will emit a notification <code>Event</code>
for all files or directories (not recursively) added to it.</p>
<h2 id="goal">Goal</h2>
<p>Define a simple interface that provides a common mechanism for reacting to
changes notified against a specific file or directory.</p>
<p>Basically we will a pass specific location to be monitored by <code>fsnotify</code>.</p>
<p>This location can be an existing file, directory or even a new location in
the file system that may still not yet exist.</p>
<h2 id="quick-start">Quick start</h2>
<p>First thing we need to know is how to use the Watcher provided by fsnotify.
Code must import <code>github.com/fsnotify/fsnotify</code> and create a <code>fsnotify.Watcher</code> instance.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">watcher</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fsnotify</span>.<span style="color:#a6e22e">NewWatcher</span>()
</span></span></code></pre></div><p>After that you must add target files or directories to watch, like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">watcher</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">filename</span>)
</span></span></code></pre></div><p>One important thing to mention here is that you must pass an existing file
or directory to be watched.</p>
<p>If you pass an invalid filename, fsnotify will report an error saying:
&ldquo;<code>no such file or directory</code>&rdquo;.</p>
<p>To get around that, our implementation will also validate if the given file
or directory exists and otherwise it will try to add the named file to the
Watcher instance till it returns no error.</p>
<p>The notification events are sent to a channel named <code>Events</code> in the <code>Watcher</code>
instance and it has a property named <code>Op</code> that represents a file operation.</p>
<p>To validate the correct operation being notified you have to perform a bitwise
<strong><code>&amp;</code></strong> (<strong>AND</strong>) operation against fsnotify generalized operations and validate
that the result matches it. As an example, to validate if a given event notification
refers to a new file or directory being created you can do:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Op</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">fsnotify</span>.<span style="color:#a6e22e">Create</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">fsnotify</span>.<span style="color:#a6e22e">Create</span>
</span></span></code></pre></div><p>With that we know what are the basics to write our own interface that helps reacting
to file system modifications more easily.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FSChangeHandler</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">OnCreate</span>(<span style="color:#66d9ef">string</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">OnUpdate</span>(<span style="color:#66d9ef">string</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">OnRemove</span>(<span style="color:#66d9ef">string</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can customize how to react to certain events more easily and leave the communication
with <code>fsnotify</code> to be handled by an internal component.</p>
<p>In order to achieve that, the sample code will offer the following function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewWatcher</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">stopCh</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">FSChangeHandler</span>) <span style="color:#66d9ef">error</span>
</span></span></code></pre></div><p>Then you can use it as you need and simply provide multiple implementations to react
to specific events differently.</p>
<h2 id="solution">Solution</h2>
<h3 id="watchergo">watcher.go</h3>
<p>Here we have the NewWatcher function that uses watchCreated to wait for new file
or directory to be created and it will use the <code>FSChangeHandler</code> interface to notify
events accordignly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">watcher</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/fsnotify/fsnotify&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FSChangeHandler</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">OnCreate</span>(<span style="color:#66d9ef">string</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">OnUpdate</span>(<span style="color:#66d9ef">string</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">OnRemove</span>(<span style="color:#66d9ef">string</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">watchCreated</span>(<span style="color:#a6e22e">watcher</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">fsnotify</span>.<span style="color:#a6e22e">Watcher</span>, <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;-&gt; waiting for %s to exist&#34;</span>, <span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ticker</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Tick</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ticker</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">watcher</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">name</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;-&gt; now it exists: %s&#34;</span>, <span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewWatcher</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">stopCh</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">FSChangeHandler</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Creating watcher for: %s&#34;</span>, <span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">watcher</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fsnotify</span>.<span style="color:#a6e22e">NewWatcher</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stat</span>(<span style="color:#a6e22e">name</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">IsNotExist</span>(<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">watchCreated</span>(<span style="color:#a6e22e">watcher</span>, <span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">watcher</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">event</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">watcher</span>.<span style="color:#a6e22e">Events</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">switch</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// useful for new files when watching directories
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Op</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">fsnotify</span>.<span style="color:#a6e22e">Create</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">fsnotify</span>.<span style="color:#a6e22e">Create</span>:
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">OnCreate</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Op</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">fsnotify</span>.<span style="color:#a6e22e">Write</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">fsnotify</span>.<span style="color:#a6e22e">Write</span>:
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">OnUpdate</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Op</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">fsnotify</span>.<span style="color:#a6e22e">Remove</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">fsnotify</span>.<span style="color:#a6e22e">Remove</span>:
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">OnRemove</span>(<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// object being watched removed, watch for it to show up again
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">name</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#a6e22e">watcher</span>.<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>						<span style="color:#a6e22e">watchCreated</span>(<span style="color:#a6e22e">watcher</span>, <span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">stopCh</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Done watching: %s&#34;</span>, <span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">watcher</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="fwgo">fw.go</h3>
<p>Here is a sample usage of the watcher presented earlier.
It provides a <code>FSChangeHandler</code> implementation that simply displays
the event type that has just been triggered and the filename.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/fgiorgetti/go-playground/filewatcher/pkg/watcher&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MyHandler</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MyHandler</span>) <span style="color:#a6e22e">OnCreate</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;File has been created: %s&#34;</span>, <span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MyHandler</span>) <span style="color:#a6e22e">OnUpdate</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;File has been updated: %s&#34;</span>, <span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MyHandler</span>) <span style="color:#a6e22e">OnRemove</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;File has been removed: %s&#34;</span>, <span style="color:#a6e22e">name</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">stopCh</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Use: %s file_or_directory&#34;</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fileOrDir</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">watcher</span>.<span style="color:#a6e22e">NewWatcher</span>(<span style="color:#a6e22e">fileOrDir</span>, <span style="color:#a6e22e">stopCh</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MyHandler</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Error creating watcher: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// var done string
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Press ENTER when done&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Scanln</span>()
</span></span><span style="display:flex;"><span>	close(<span style="color:#a6e22e">stopCh</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="running">Running</h3>
<p>To run it you must pass a single target file to be watched.
Remember it may or may not exist.</p>
<p>In a separate terminal you can play with modifications to the respective file.</p>
<p>Once you&rsquo;re done with it, just press ENTER in the terminal where the watcher
is running.</p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>go run fw.go /tmp/sample-location
</span></span></code></pre></div><p>It will show you something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2022/08/23 12:26:52 Creating watcher <span style="color:#66d9ef">for</span>: /tmp/sample-location
</span></span><span style="display:flex;"><span>2022/08/23 12:26:52 -&gt; waiting <span style="color:#66d9ef">for</span> /tmp/sample-location to exist
</span></span><span style="display:flex;"><span>Press ENTER when <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>In another terminal you can create a file and add more content to it, like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;some data&#34;</span> &gt;&gt; /tmp/sample-location
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;some more data&#34;</span> &gt;&gt; /tmp/sample-location
</span></span></code></pre></div><p>Then in the main terminal you will see:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2022/08/23 12:27:07 -&gt; now it exists: /tmp/sample-location
</span></span><span style="display:flex;"><span>2022/08/23 12:28:40 File has been updated: /tmp/sample-location
</span></span></code></pre></div><p>Remove the file now:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rm /tmp/sample-location
</span></span></code></pre></div><p>And in the main terminal you should see:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2022/08/23 12:29:56 File has been removed: /tmp/sample-location
</span></span><span style="display:flex;"><span>2022/08/23 12:29:56 -&gt; waiting <span style="color:#66d9ef">for</span> /tmp/sample-location to exist
</span></span></code></pre></div><p>Next, create the target <code>/tmp/sample-location</code> as a directory and
create a file inside it with some sample content:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir /tmp/sample-location
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;some data&#34;</span> &gt;&gt; /tmp/sample-location/file1
</span></span></code></pre></div><p>You should see:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2022/08/23 12:31:18 -&gt; now it exists: /tmp/sample-location
</span></span><span style="display:flex;"><span>2022/08/23 12:31:40 File has been created: /tmp/sample-location/file1
</span></span><span style="display:flex;"><span>2022/08/23 12:31:40 File has been updated: /tmp/sample-location/file1
</span></span></code></pre></div><p>I hope you find it useful.</p>
<h2 id="system-information">System information</h2>
<p>FSNotify v1.5.4
OS: Fedora 36
Go: 1.19</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://github.com/fsnotify/fsnotify/tree/v1.5.4">fsnotify source code</a></li>
<li><a href="https://pkg.go.dev/github.com/fsnotify/fsnotify">fsnotify documentation</a></li>
<li><a href="https://github.com/fgiorgetti/go-playground/tree/main/filewatcher">source code used here</a></li>
</ul>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Writings</a></li>
         
          <li><a href="/tags">Tags</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#fsnotify">fsnotify</a></li>
    <li><a href="#goal">Goal</a></li>
    <li><a href="#quick-start">Quick start</a></li>
    <li><a href="#solution">Solution</a>
      <ul>
        <li><a href="#watchergo">watcher.go</a></li>
        <li><a href="#fwgo">fw.go</a></li>
        <li><a href="#running">Running</a></li>
      </ul>
    </li>
    <li><a href="#system-information">System information</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&text=File%20Watcher%20With%20Fsnotify" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&title=File%20Watcher%20With%20Fsnotify" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&is_video=false&description=File%20Watcher%20With%20Fsnotify" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=File%20Watcher%20With%20Fsnotify&body=Check out this article: https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&title=File%20Watcher%20With%20Fsnotify" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&title=File%20Watcher%20With%20Fsnotify" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&name=File%20Watcher%20With%20Fsnotify&description=Sometimes%20we%20need%20to%20watch%20for%20modifications%20in%20specific%20locations%20in%20the%20filesystem%2c%20reacting%20to%20them%20differently.%0aAs%20an%20example%2c%20an%20alert%20could%20be%20triggered%20if%20a%20specific%20file%20is%20modified%20or%20a%20backup%20procedure%20could%20start%20as%20new%20files%20are%20created%20into%20specific%20directories.%0aThere%20are%20several%20tools%20and%20libraries%20to%20help%20doing%20that%2c%20but%20since%20I%20am%20evaluating%20libraries%20in%20Go%2c%20I%20have%20decided%20to%20play%20with%20fsnotify%20and%20write%20a%20bit%20about%20it." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2ffgiorgetti.github.io%2fposts%2f20220823-file-watcher-with-fsnotify%2f&t=File%20Watcher%20With%20Fsnotify" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2022  Fernando Giorgetti 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
